<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Feed - FamilyConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f7fafc; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; padding: 24px; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 32px; cursor: pointer; }
        .nav-item { padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #4a5568; text-decoration: none; font-size: 14px; }
        .nav-item:hover { background: #f7fafc; }
        .nav-item.active { background: #667eea; color: white; }
        .main { flex: 1; padding: 32px; margin-left: 260px; max-width: 800px; margin-right: auto; }

        .create-post { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .create-post textarea { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 16px; min-height: 100px; resize: vertical; }
        .create-post textarea:focus { outline: none; border-color: #667eea; }
        .create-post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
        .btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; }

        .post { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .post-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .post-avatar { width: 48px; height: 48px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; }
        .post-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .post-author-info h3 { font-size: 16px; color: #2d3748; margin-bottom: 4px; }
        .post-author-info p { font-size: 14px; color: #718096; }
        .post-content { color: #2d3748; line-height: 1.6; margin-bottom: 16px; font-size: 15px; }
        .post-actions { display: flex; gap: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
        .post-action { display: flex; align-items: center; gap: 8px; color: #718096; cursor: pointer; font-size: 14px; font-weight: 500; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; }
        .post-action:hover { background: #f7fafc; color: #667eea; }
        .post-action.liked { color: #e53e3e; }

        .comments-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
        .comment { display: flex; gap: 12px; margin-bottom: 16px; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .comment-content { background: #f7fafc; padding: 12px; border-radius: 8px; flex: 1; }
        .comment-author { font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 4px; }
        .comment-text { color: #4a5568; font-size: 14px; line-height: 1.5; }
        .comment-input { display: flex; gap: 12px; margin-top: 16px; }
        .comment-input input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .comment-input input:focus { outline: none; border-color: #667eea; }
        .comment-input button { padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .comment-input button:hover { background: #5568d3; }

        .empty-state { text-align: center; padding: 64px 24px; color: #718096; }
        .empty-state i { font-size: 64px; color: #cbd5e0; margin-bottom: 16px; }
        .empty-state h3 { font-size: 20px; margin-bottom: 8px; color: #2d3748; }

        .media-upload-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
        .media-upload-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #4a5568; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .media-upload-btn:hover { border-color: #667eea; color: #667eea; background: #f7fafc; }
        .media-upload-btn input[type="file"] { display: none; }
        .media-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px; }
        .media-preview { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
        .media-preview img, .media-preview video { width: 100%; height: 100%; object-fit: cover; }
        .media-preview-remove { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .media-preview-remove:hover { background: #e53e3e; }
        .post-media { margin-top: 16px; }
        .post-media-grid { display: grid; gap: 8px; }
        .post-media-grid.single { grid-template-columns: 1fr; }
        .post-media-grid.double { grid-template-columns: repeat(2, 1fr); }
        .post-media-grid.multiple { grid-template-columns: repeat(3, 1fr); }
        .post-media-item { border-radius: 12px; overflow: hidden; cursor: pointer; }
        .post-media-item img, .post-media-item video { width: 100%; height: 100%; object-fit: cover; max-height: 400px; }
        .post-link-preview { margin-top: 16px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .post-link-preview img { width: 100%; height: 200px; object-fit: cover; }
        .post-link-preview-content { padding: 16px; }
        .post-link-preview-title { font-weight: 600; color: #2d3748; margin-bottom: 4px; }
        .post-link-preview-url { font-size: 12px; color: #718096; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo" onclick="window.location.href='../dashboard/index.html'"><i class="fas fa-users"></i> FamilyConnect</div>
            <a href="../dashboard/index.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="../tree/builder.html" class="nav-item"><i class="fas fa-project-diagram"></i> Family Tree Builder</a>
            <a href="../tree/viewer.html" class="nav-item"><i class="fas fa-sitemap"></i> Tree Viewer</a>
            <a href="../tree/pathfinder.html" class="nav-item"><i class="fas fa-route"></i> Connection Finder</a>
            <a href="../tree/templates.html" class="nav-item"><i class="fas fa-print"></i> Print Templates</a>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid #e2e8f0;">
            <a href="index.html" class="nav-item active"><i class="fas fa-images"></i> Family Feed</a>
            <a href="../business/index.html" class="nav-item"><i class="fas fa-store"></i> Businesses</a>
            <a href="../profile/view.html" class="nav-item"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="signOut()" class="nav-item"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>

        <div class="main">
            <h1 style="font-size: 32px; color: #2d3748; margin-bottom: 24px;">Family Feed</h1>

            <div class="create-post">
                <textarea id="postContent" placeholder="Share something with your family..."></textarea>
                <div id="mediaPreviewContainer" class="media-preview-container"></div>
                <div class="media-upload-section">
                    <label class="media-upload-btn">
                        <i class="fas fa-image"></i>
                        <span>Photo/Video</span>
                        <input type="file" id="mediaInput" accept="image/*,video/*" multiple onchange="handleMediaSelect(event)">
                    </label>
                    <label class="media-upload-btn" style="margin-left: 12px;">
                        <i class="fas fa-link"></i>
                        <span id="linkBtnText">Add Link</span>
                        <input type="text" id="linkInput" style="display: none; width: 300px; margin-left: 8px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;" placeholder="Paste URL...">
                    </label>
                </div>
                <div class="create-post-actions">
                    <span style="color: #718096; font-size: 14px;"><i class="fas fa-users"></i> Visible to all family members</span>
                    <button class="btn" onclick="createPost()"><i class="fas fa-paper-plane"></i> Post</button>
                </div>
            </div>

            <div id="postsContainer"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://fvfviudlxyumnskakftp.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2ZnZpdWRseHl1bW5za2FrZnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjExMDEsImV4cCI6MjA3ODg5NzEwMX0.fODOqTUm9g_20Jbxz5J5s_L-PwcH-mKfNp_3741fAnA'
        );

        let currentUser = null;
        let currentProfile = null;
        let selectedFiles = [];
        let uploadedMediaUrls = [];

        window.signOut = async function() {
            await supabase.auth.signOut();
            window.location.href = '../index.html';
        };

        window.handleMediaSelect = function(event) {
            selectedFiles = Array.from(event.target.files);
            displayMediaPreviews();
        };

        function displayMediaPreviews() {
            const container = document.getElementById('mediaPreviewContainer');
            container.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';

                    const mediaElement = file.type.startsWith('video/')
                        ? `<video src="${e.target.result}" muted></video>`
                        : `<img src="${e.target.result}" alt="Preview">`;

                    preview.innerHTML = `
                        ${mediaElement}
                        <button class="media-preview-remove" onclick="removeMedia(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
        }

        window.removeMedia = function(index) {
            selectedFiles.splice(index, 1);
            displayMediaPreviews();
        };

        async function uploadMediaFiles() {
            const urls = [];

            for (const file of selectedFiles) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

                const { data, error } = await supabase.storage
                    .from('post-media')
                    .upload(fileName, file);

                if (!error) {
                    const { data: { publicUrl } } = supabase.storage
                        .from('post-media')
                        .getPublicUrl(fileName);

                    urls.push({
                        url: publicUrl,
                        type: file.type.startsWith('video/') ? 'video' : 'image'
                    });
                }
            }

            return urls;
        }

        window.createPost = async function() {
            const content = document.getElementById('postContent').value.trim();
            const linkInput = document.getElementById('linkInput').value.trim();

            if (!content && selectedFiles.length === 0 && !linkInput) return;

            let mediaUrls = [];
            if (selectedFiles.length > 0) {
                mediaUrls = await uploadMediaFiles();
            }

            const postData = {
                author_id: currentUser.id,
                content: content || ''
            };

            if (mediaUrls.length > 0 || linkInput) {
                postData.media_urls = mediaUrls.length > 0 ? mediaUrls : (linkInput ? [{ url: linkInput, type: 'link' }] : null);
            }

            const { error } = await supabase
                .from('posts')
                .insert(postData);

            if (!error) {
                document.getElementById('postContent').value = '';
                document.getElementById('linkInput').value = '';
                document.getElementById('linkInput').style.display = 'none';
                document.getElementById('linkBtnText').style.display = 'inline';
                document.getElementById('mediaInput').value = '';
                selectedFiles = [];
                document.getElementById('mediaPreviewContainer').innerHTML = '';
                await loadPosts();
            }
        };

        window.toggleLike = async function(postId) {
            const { data: existing } = await supabase
                .from('post_likes')
                .select('id')
                .eq('post_id', postId)
                .eq('profile_id', currentUser.id)
                .maybeSingle();

            if (existing) {
                await supabase.from('post_likes').delete().eq('id', existing.id);
            } else {
                await supabase.from('post_likes').insert({ post_id: postId, profile_id: currentUser.id });
            }

            await loadPosts();
        };

        window.addComment = async function(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;

            await supabase.from('post_comments').insert({
                post_id: postId,
                profile_id: currentUser.id,
                content: content
            });

            input.value = '';
            await loadPosts();
        };

        async function loadPosts() {
            const { data: posts } = await supabase
                .from('posts')
                .select(`
                    *,
                    author:author_id (first_name, last_name, avatar_url),
                    likes:post_likes (profile_id),
                    comments:post_comments (
                        *,
                        author:profile_id (first_name, last_name, avatar_url)
                    )
                `)
                .order('created_at', { ascending: false });

            const container = document.getElementById('postsContainer');

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No posts yet</h3>
                        <p>Be the first to share something with your family!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const authorName = post.author ? `${post.author.first_name} ${post.author.last_name}` : 'Unknown';
                const authorInitials = authorName.split(' ').map(n => n[0]).join('');
                const likeCount = post.likes?.length || 0;
                const isLiked = post.likes?.some(l => l.profile_id === currentUser.id);
                const timeAgo = getTimeAgo(post.created_at);

                return `
                    <div class="post">
                        <div class="post-header">
                            <div class="post-avatar">${authorInitials}</div>
                            <div class="post-author-info">
                                <h3>${authorName}</h3>
                                <p>${timeAgo}</p>
                            </div>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        ${renderPostMedia(post.media_urls)}
                        <div class="post-actions">
                            <div class="post-action ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                                <i class="fas fa-heart"></i>
                                <span>${likeCount} ${likeCount === 1 ? 'Like' : 'Likes'}</span>
                            </div>
                            <div class="post-action">
                                <i class="fas fa-comment"></i>
                                <span>${post.comments?.length || 0} ${post.comments?.length === 1 ? 'Comment' : 'Comments'}</span>
                            </div>
                        </div>
                        <div class="comments-section">
                            ${(post.comments || []).map(comment => {
                                const commentAuthor = comment.author ? `${comment.author.first_name} ${comment.author.last_name}` : 'Unknown';
                                const commentInitials = commentAuthor.split(' ').map(n => n[0]).join('');
                                return `
                                    <div class="comment">
                                        <div class="comment-avatar">${commentInitials}</div>
                                        <div class="comment-content">
                                            <div class="comment-author">${commentAuthor}</div>
                                            <div class="comment-text">${comment.content}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <div class="comment-input">
                                <input type="text" id="comment-input-${post.id}" placeholder="Write a comment...">
                                <button onclick="addComment('${post.id}')">Post</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderPostMedia(mediaUrls) {
            if (!mediaUrls || mediaUrls.length === 0) return '';

            const media = Array.isArray(mediaUrls) ? mediaUrls : [];
            const links = media.filter(m => m.type === 'link');
            const images = media.filter(m => m.type === 'image');
            const videos = media.filter(m => m.type === 'video');
            const allMedia = [...images, ...videos];

            let html = '';

            if (allMedia.length > 0) {
                const gridClass = allMedia.length === 1 ? 'single' : allMedia.length === 2 ? 'double' : 'multiple';
                html += `<div class="post-media"><div class="post-media-grid ${gridClass}">`;

                allMedia.forEach(item => {
                    if (item.type === 'image') {
                        html += `<div class="post-media-item"><img src="${item.url}" alt="Post image"></div>`;
                    } else if (item.type === 'video') {
                        html += `<div class="post-media-item"><video src="${item.url}" controls></video></div>`;
                    }
                });

                html += `</div></div>`;
            }

            if (links.length > 0) {
                links.forEach(link => {
                    html += `
                        <div class="post-link-preview">
                            <div class="post-link-preview-content">
                                <div class="post-link-preview-title"><i class="fas fa-link"></i> ${link.url}</div>
                                <div class="post-link-preview-url">${new URL(link.url).hostname}</div>
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        document.addEventListener('click', function(e) {
            if (e.target.closest('.media-upload-btn') && e.target.closest('.media-upload-btn').textContent.includes('Add Link')) {
                const linkInput = document.getElementById('linkInput');
                const linkBtn = document.getElementById('linkBtnText');
                if (linkInput.style.display === 'none') {
                    linkInput.style.display = 'inline-block';
                    linkBtn.style.display = 'none';
                    linkInput.focus();
                }
            }
        });

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '../auth/login.html';
                return;
            }

            currentUser = session.user;

            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .maybeSingle();

            currentProfile = profile;
            await loadPosts();
        }

        init();
    </script>
</body>
</html>

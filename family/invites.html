<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invite Family - FamilyConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f7fafc; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; padding: 24px; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 32px; cursor: pointer; }
        .nav-item { padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #4a5568; text-decoration: none; font-size: 14px; }
        .nav-item:hover { background: #f7fafc; }
        .nav-item.active { background: #667eea; color: white; }
        .main { flex: 1; padding: 32px; margin-left: 260px; max-width: 900px; }
        h1 { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 8px; }
        .subtitle { color: #718096; margin-bottom: 32px; }
        .card { background: white; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .card h2 { font-size: 20px; margin-bottom: 16px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }
        .btn-secondary:hover { background: #cbd5e0; }

        .invite-card { background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e2e8f0; }
        .invite-header { display: flex; justify-content: between; align-items: start; margin-bottom: 12px; }
        .invite-email { font-weight: 600; color: #2d3748; }
        .invite-status { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-accepted { background: #d1fae5; color: #065f46; }
        .status-expired { background: #fee2e2; color: #991b1b; }
        .invite-code { background: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 14px; margin: 12px 0; display: inline-block; border: 1px dashed #cbd5e0; }
        .copy-btn { margin-left: 8px; padding: 4px 8px; font-size: 12px; }

        .share-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 24px; }
        .share-card { background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .share-card:hover { border-color: #667eea; background: white; }
        .share-card i { font-size: 32px; color: #667eea; margin-bottom: 12px; }
        .share-card h3 { font-size: 16px; margin-bottom: 4px; }
        .share-card p { font-size: 14px; color: #718096; }

        .success-message { background: #d1fae5; color: #065f46; padding: 16px; border-radius: 8px; margin-bottom: 24px; display: none; }
        .success-message.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo" onclick="location.href='../dashboard/index.html'">
                <i class="fas fa-users"></i> FamilyConnect
            </div>
            <a href="../dashboard/index.html" class="nav-item">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
            <a href="../tree/builder.html" class="nav-item">
                <i class="fas fa-project-diagram"></i> Family Tree
            </a>
            <a href="../feed/index.html" class="nav-item">
                <i class="fas fa-images"></i> Family Feed
            </a>
            <a href="invites.html" class="nav-item active">
                <i class="fas fa-user-plus"></i> Invite Family
            </a>
            <a href="manage.html" class="nav-item">
                <i class="fas fa-users-cog"></i> Manage Family
            </a>
            <a href="../profile/view.html" class="nav-item">
                <i class="fas fa-user"></i> Profile
            </a>
            <a href="#" onclick="signOut()" class="nav-item">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </a>
        </div>

        <div class="main">
            <h1>Invite Family Members</h1>
            <p class="subtitle">Grow your family tree by inviting relatives to join</p>

            <div id="successMessage" class="success-message">
                <i class="fas fa-check-circle"></i> <span id="successText">Invitation sent!</span>
            </div>

            <div class="card">
                <h2><i class="fas fa-envelope"></i> Send Invitation by Email</h2>
                <p style="color: #718096; margin-bottom: 24px;">Invite someone to join your family tree</p>

                <form id="inviteForm">
                    <div class="form-group">
                        <label>Recipient Email Address</label>
                        <input type="email" id="recipientEmail" placeholder="relative@example.com" required>
                    </div>

                    <div class="form-group">
                        <label>Personal Message (Optional)</label>
                        <textarea id="inviteMessage" placeholder="Hi! Join our family tree on FamilyConnect so we can all stay connected..."></textarea>
                    </div>

                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Send Invitation
                    </button>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-share-alt"></i> Share Your Invite Link</h2>
                <p style="color: #718096; margin-bottom: 16px;">Generate a shareable link that anyone can use to join your family</p>

                <button onclick="generateShareLink()" class="btn">
                    <i class="fas fa-link"></i> Generate Invite Link
                </button>

                <div id="shareLinkSection" style="display: none; margin-top: 24px;">
                    <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Invite Link:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="shareLink" readonly style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white;">
                            <button onclick="copyShareLink()" class="btn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>

                    <div class="share-options">
                        <div class="share-card" onclick="shareViaWhatsApp()">
                            <i class="fab fa-whatsapp"></i>
                            <h3>WhatsApp</h3>
                            <p>Share via WhatsApp</p>
                        </div>
                        <div class="share-card" onclick="shareViaEmail()">
                            <i class="fas fa-envelope"></i>
                            <h3>Email</h3>
                            <p>Share via Email</p>
                        </div>
                        <div class="share-card" onclick="shareViaSMS()">
                            <i class="fas fa-sms"></i>
                            <h3>Text Message</h3>
                            <p>Share via SMS</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-clock"></i> Pending Invitations</h2>
                <div id="invitesList">
                    <p style="color: #718096; text-align: center; padding: 32px;">No pending invitations</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://fvfviudlxyumnskakftp.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2ZnZpdWRseHl1bW5za2FrZnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjExMDEsImV4cCI6MjA3ODg5NzEwMX0.fODOqTUm9g_20Jbxz5J5s_L-PwcH-mKfNp_3741fAnA'
        );

        let currentUser = null;
        let currentInviteCode = null;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '../auth/login.html';
                return null;
            }
            currentUser = session.user;
            return session.user;
        }

        window.signOut = async () => {
            await supabase.auth.signOut();
            window.location.href = '../auth/login.html';
        };

        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;

            const recipientEmail = document.getElementById('recipientEmail').value;
            const message = document.getElementById('inviteMessage').value;

            const { data, error } = await supabase
                .from('invitations')
                .insert({
                    sender_id: currentUser.id,
                    recipient_email: recipientEmail,
                    message: message,
                    status: 'pending'
                })
                .select()
                .single();

            if (error) {
                alert('Error sending invitation: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            await supabase
                .from('notifications')
                .insert({
                    user_id: currentUser.id,
                    actor_id: currentUser.id,
                    type: 'invitation_sent',
                    title: 'Invitation Sent',
                    message: `Invitation sent to ${recipientEmail}`,
                    read: false
                });

            document.getElementById('successText').textContent = `Invitation sent to ${recipientEmail}!`;
            document.getElementById('successMessage').classList.add('show');

            setTimeout(() => {
                document.getElementById('successMessage').classList.remove('show');
            }, 5000);

            document.getElementById('inviteForm').reset();
            btn.innerHTML = originalText;
            btn.disabled = false;

            loadInvitations();
        });

        window.generateShareLink = async () => {
            const { data, error } = await supabase
                .from('invitations')
                .insert({
                    sender_id: currentUser.id,
                    recipient_email: 'via-link',
                    status: 'pending'
                })
                .select()
                .single();

            if (error) {
                alert('Error generating link: ' + error.message);
                return;
            }

            currentInviteCode = data.invite_code;
            const link = `${window.location.origin}/family/join.html?code=${data.invite_code}`;

            document.getElementById('shareLink').value = link;
            document.getElementById('shareLinkSection').style.display = 'block';

            loadInvitations();
        };

        window.copyShareLink = () => {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            document.execCommand('copy');

            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        };

        window.shareViaWhatsApp = () => {
            const link = document.getElementById('shareLink').value;
            const text = `Join our family tree on FamilyConnect! ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.shareViaEmail = () => {
            const link = document.getElementById('shareLink').value;
            const subject = 'Join Our Family Tree on FamilyConnect';
            const body = `Hi!\n\nI'd love for you to join our family tree on FamilyConnect. It's a great way to stay connected with family and preserve our family history.\n\nClick here to join: ${link}\n\nLooking forward to seeing you there!`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        };

        window.shareViaSMS = () => {
            const link = document.getElementById('shareLink').value;
            const text = `Join our family tree on FamilyConnect! ${link}`;
            window.location.href = `sms:?body=${encodeURIComponent(text)}`;
        };

        async function loadInvitations() {
            const { data: invites, error } = await supabase
                .from('invitations')
                .select('*')
                .eq('sender_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading invitations:', error);
                return;
            }

            const container = document.getElementById('invitesList');

            if (!invites || invites.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 32px;">No pending invitations</p>';
                return;
            }

            container.innerHTML = invites.map(invite => {
                const statusClass = `status-${invite.status}`;
                const expiresDate = new Date(invite.expires_at).toLocaleDateString();
                const isExpired = new Date(invite.expires_at) < new Date();

                return `
                    <div class="invite-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div class="invite-email">${invite.recipient_email}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">
                                    ${invite.message ? invite.message.substring(0, 60) + '...' : 'No message'}
                                </div>
                            </div>
                            <span class="invite-status ${statusClass}">${invite.status}</span>
                        </div>
                        <div style="font-size: 12px; color: #718096;">
                            <i class="fas fa-clock"></i> ${isExpired ? 'Expired' : 'Expires'} ${expiresDate}
                        </div>
                        ${invite.recipient_email !== 'via-link' ? '' : `
                            <div class="invite-code">
                                ${window.location.origin}/family/join.html?code=${invite.invite_code}
                                <button onclick="copyInviteCode('${invite.invite_code}')" class="btn btn-secondary copy-btn">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        window.copyInviteCode = (code) => {
            const link = `${window.location.origin}/family/join.html?code=${code}`;
            navigator.clipboard.writeText(link);

            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        };

        async function init() {
            await checkAuth();
            await loadInvitations();
        }

        init();
    </script>
</body>
</html>

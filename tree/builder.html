<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Builder - FamilyConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f7fafc; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; padding: 24px; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 32px; cursor: pointer; }
        .nav-item { padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #4a5568; text-decoration: none; font-size: 14px; }
        .nav-item:hover { background: #f7fafc; }
        .nav-item.active { background: #667eea; color: white; }
        .main { flex: 1; padding: 32px; margin-left: 260px; max-width: 1200px; }
        .card { background: white; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        h1 { font-family: 'Playfair Display', serif; margin-bottom: 8px; font-size: 32px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748; }
        .form-group label .required { color: #e53e3e; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-sm { padding: 8px 12px; font-size: 13px; }

        .member-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 24px; }
        .member-card { background: #f7fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; }
        .member-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .member-card h3 { color: #2d3748; font-size: 18px; }
        .deceased-badge { background: #718096; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .member-card p { color: #718096; font-size: 14px; margin-bottom: 6px; }
        .member-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }

        .relationship-section { background: #fffbeb; border: 2px solid #fbbf24; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .relationship-section h3 { color: #92400e; margin-bottom: 12px; font-size: 16px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 24px; color: #2d3748; }
        .close-modal { background: none; border: none; font-size: 28px; color: #718096; cursor: pointer; padding: 0; width: 32px; height: 32px; }
        .close-modal:hover { color: #2d3748; }
        .invite-link-box { background: #f7fafc; padding: 16px; border-radius: 8px; border: 2px solid #e2e8f0; margin: 16px 0; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; color: #2d3748; }
        .quick-add-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        .quick-btn { padding: 16px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; color: #2d3748; transition: all 0.2s; }
        .quick-btn:hover { background: #667eea; color: white; border-color: #667eea; }
        .quick-btn i { display: block; font-size: 24px; margin-bottom: 8px; }
        .success-message { background: #c6f6d5; color: #22543d; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo" onclick="window.location.href='../dashboard/index.html'"><i class="fas fa-users"></i> FamilyConnect</div>
            <a href="../dashboard/index.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="builder.html" class="nav-item active"><i class="fas fa-project-diagram"></i> Family Tree Builder</a>
            <a href="viewer.html" class="nav-item"><i class="fas fa-sitemap"></i> Tree Viewer</a>
            <a href="pathfinder.html" class="nav-item"><i class="fas fa-route"></i> Connection Finder</a>
            <a href="templates.html" class="nav-item"><i class="fas fa-print"></i> Print Templates</a>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid #e2e8f0;">
            <a href="../feed/index.html" class="nav-item"><i class="fas fa-images"></i> Family Feed</a>
            <a href="../business/index.html" class="nav-item"><i class="fas fa-store"></i> Businesses</a>
            <a href="../profile/view.html" class="nav-item"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="signOut()" class="nav-item"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>

        <div class="main">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1>Build Your Family Tree</h1>
                    <p style="color: #718096;">Add family members and specify relationships</p>
                </div>
                <button class="btn" onclick="openShareModal()" style="background: #48bb78;">
                    <i class="fas fa-share-alt"></i> Share Your Tree
                </button>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Add Family Member</h2>
                <form id="addMemberForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="gender">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Birth Date</label>
                            <input type="date" id="birthDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label><input type="checkbox" id="isDeceased" style="width: auto; margin-right: 8px;"> Deceased (Ancestor)</label>
                    </div>
                    <div class="form-group" id="deathDateGroup" style="display: none;">
                        <label>Death Date</label>
                        <input type="date" id="deathDate">
                    </div>

                    <div class="relationship-section">
                        <h3><i class="fas fa-link"></i> Connect to Family Tree</h3>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Connect to:</label>
                            <select id="relatedMember">
                                <option value="">Select family member...</option>
                            </select>
                        </div>
                        <div class="form-group" id="relationshipTypeGroup" style="display: none;">
                            <label>This person is the:</label>
                            <select id="relationshipType">
                                <option value="">Select relationship...</option>
                                <option value="parent">Parent</option>
                                <option value="child">Child</option>
                                <option value="spouse">Spouse</option>
                                <option value="sibling">Sibling</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location">
                    </div>
                    <div class="form-group">
                        <label>Biography</label>
                        <textarea id="bio"></textarea>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Add Member</button>
                </form>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 16px;">Family Members (<span id="memberCount">0</span>)</h2>
                <div class="member-list" id="memberList"></div>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-share-alt"></i> Share Your Family Tree</h2>
                <button class="close-modal" onclick="closeShareModal()">&times;</button>
            </div>
            <p style="color: #718096; margin-bottom: 16px;">Invite family members to join and build your tree together!</p>
            <div id="shareSuccess" style="display: none;" class="success-message">
                <i class="fas fa-check-circle"></i>
                <span>Invite link generated!</span>
            </div>
            <div class="invite-link-box" id="inviteLinkBox">Generating link...</div>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="copyInviteLink()" style="flex: 1;"><i class="fas fa-copy"></i> Copy Link</button>
                <button class="btn" onclick="shareViaEmail()" style="flex: 1; background: #48bb78;"><i class="fas fa-envelope"></i> Share via Email</button>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-paper-plane"></i> Invite to Claim Profile</h2>
                <button class="close-modal" onclick="closeInviteModal()">&times;</button>
            </div>
            <p style="color: #718096; margin-bottom: 16px;">Send an invitation to <strong id="invitePersonName"></strong> to claim their profile.</p>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="inviteEmail" placeholder="person@example.com">
            </div>
            <div class="form-group">
                <label>Personal Message (Optional)</label>
                <textarea id="inviteMessage" placeholder="Hey! I'm building our family tree. Join me!"></textarea>
            </div>
            <div id="inviteSuccess" style="display: none;" class="success-message">
                <i class="fas fa-check-circle"></i>
                <span id="inviteSuccessMsg">Invite sent!</span>
            </div>
            <div class="invite-link-box" id="personalInviteLink" style="display: none;">Link here</div>
            <button class="btn" onclick="sendPersonalInvite()" style="width: 100%;"><i class="fas fa-paper-plane"></i> Send Invitation</button>
        </div>
    </div>

    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Quick Add Family Member</h2>
                <button class="close-modal" onclick="closeQuickAddModal()">&times;</button>
            </div>
            <p style="color: #718096; margin-bottom: 16px;">Add a family member related to <strong id="relatedPersonName"></strong></p>
            <div class="quick-add-actions">
                <div class="quick-btn" onclick="quickAddRelation('parent')">
                    <i class="fas fa-user-friends"></i>
                    <div>Add Parent</div>
                </div>
                <div class="quick-btn" onclick="quickAddRelation('child')">
                    <i class="fas fa-baby"></i>
                    <div>Add Child</div>
                </div>
                <div class="quick-btn" onclick="quickAddRelation('sibling')">
                    <i class="fas fa-users"></i>
                    <div>Add Sibling</div>
                </div>
                <div class="quick-btn" onclick="quickAddRelation('spouse')">
                    <i class="fas fa-heart"></i>
                    <div>Add Spouse</div>
                </div>
            </div>
            <div id="quickAddForm" style="display: none; margin-top: 24px;">
                <h3 style="margin-bottom: 16px; color: #2d3748;">Person Details</h3>
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="quickFirstName">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="quickLastName">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="quickGender">
                        <option value="">Select...</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <button class="btn" onclick="submitQuickAdd()" style="width: 100%;"><i class="fas fa-check"></i> Add Person</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        const supabase = createClient('https://fvfviudlxyumnskakftp.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2ZnZpdWRseHl1bW5za2FrZnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjExMDEsImV4cCI6MjA3ODg5NzEwMX0.fODOqTUm9g_20Jbxz5J5s_L-PwcH-mKfNp_3741fAnA');
        let currentUser = null;

        window.signOut = async () => { await supabase.auth.signOut(); window.location.href = '../index.html'; };
        
        document.getElementById('isDeceased').addEventListener('change', e => {
            document.getElementById('deathDateGroup').style.display = e.target.checked ? 'block' : 'none';
        });
        
        document.getElementById('relatedMember').addEventListener('change', e => {
            document.getElementById('relationshipTypeGroup').style.display = e.target.value ? 'block' : 'none';
        });

        document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: member } = await supabase.from('family_members').insert({
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                gender: document.getElementById('gender').value,
                birth_date: document.getElementById('birthDate').value || null,
                death_date: document.getElementById('isDeceased').checked ? document.getElementById('deathDate').value : null,
                is_deceased: document.getElementById('isDeceased').checked,
                location: document.getElementById('location').value,
                bio: document.getElementById('bio').value,
                created_by: currentUser.id
            }).select().single();

            const relatedId = document.getElementById('relatedMember').value;
            const relType = document.getElementById('relationshipType').value;
            if (relatedId && relType && member) {
                if (relType === 'parent') await supabase.from('relationships').insert({ parent_id: member.id, child_id: relatedId, relationship_type: 'parent' });
                else if (relType === 'child') await supabase.from('relationships').insert({ parent_id: relatedId, child_id: member.id, relationship_type: 'parent' });
                else if (relType === 'spouse' || relType === 'sibling') await supabase.from('relationships').insert([
                    { parent_id: member.id, child_id: relatedId, relationship_type: relType },
                    { parent_id: relatedId, child_id: member.id, relationship_type: relType }
                ]);
            }
            document.getElementById('addMemberForm').reset();
            loadMembers();
        });

        window.deleteMember = async (id) => { if(confirm('Delete?')) { await supabase.from('family_members').delete().eq('id', id); loadMembers(); }};

        async function loadMembers() {
            const { data: members } = await supabase.from('family_members').select('*').order('created_at', { ascending: false });
            document.getElementById('memberCount').textContent = members?.length || 0;
            const select = document.getElementById('relatedMember');
            select.innerHTML = '<option value="">Select...</option>';
            if (members) members.forEach(m => select.innerHTML += `<option value="${m.id}">${m.first_name} ${m.last_name || ''}</option>`);
            
            const list = document.getElementById('memberList');
            if (!members || !members.length) { list.innerHTML = '<p style="color: #718096; grid-column: 1/-1; text-align: center; padding: 32px;">No members yet</p>'; return; }
            list.innerHTML = members.map(m => `
                <div class="member-card">
                    <div class="member-header">
                        <h3>${m.first_name} ${m.last_name || ''}</h3>
                        ${m.is_deceased ? '<span class="deceased-badge">Ancestor</span>' : ''}
                    </div>
                    ${m.birth_date ? `<p><i class="fas fa-birthday-cake"></i> Born: ${new Date(m.birth_date).toLocaleDateString()}</p>` : ''}
                    ${m.death_date ? `<p><i class="fas fa-cross"></i> Died: ${new Date(m.death_date).toLocaleDateString()}</p>` : ''}
                    ${m.location ? `<p><i class="fas fa-map-marker-alt"></i> ${m.location}</p>` : ''}
                    <div class="member-actions">
                        <button class="btn btn-sm" onclick="openQuickAddModal('${m.id}', '${m.first_name} ${m.last_name || ''}')"><i class="fas fa-plus"></i> Quick Add</button>
                        <button class="btn btn-sm btn-secondary" onclick="openInviteModal('${m.id}', '${m.first_name}')"><i class="fas fa-paper-plane"></i> Invite</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteMember('${m.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        let currentInviteLink = '';
        let currentQuickAddRelation = '';
        let currentQuickAddMemberId = '';
        let currentInviteMemberId = '';

        window.openShareModal = async () => {
            document.getElementById('shareModal').classList.add('active');
            document.getElementById('shareSuccess').style.display = 'none';
            document.getElementById('inviteLinkBox').textContent = 'Generating link...';

            const { data, error } = await supabase.from('invitations').insert({
                sender_id: currentUser.id
            }).select().single();

            if (data) {
                currentInviteLink = `${window.location.origin}/auth/signup.html?invite=${data.invite_code}`;
                document.getElementById('inviteLinkBox').textContent = currentInviteLink;
                document.getElementById('shareSuccess').style.display = 'flex';
            }
        };

        window.closeShareModal = () => {
            document.getElementById('shareModal').classList.remove('active');
        };

        window.copyInviteLink = async () => {
            await navigator.clipboard.writeText(currentInviteLink);
            alert('Link copied to clipboard!');
        };

        window.shareViaEmail = () => {
            const subject = encodeURIComponent('Join Our Family Tree on FamilyConnect!');
            const body = encodeURIComponent(`Hi!\n\nI'm building our family tree on FamilyConnect and would love for you to join!\n\nClick here to create your account and claim your profile:\n${currentInviteLink}\n\nLooking forward to connecting!`);
            window.open(`mailto:?subject=${subject}&body=${body}`);
        };

        window.openInviteModal = (memberId, firstName) => {
            currentInviteMemberId = memberId;
            document.getElementById('invitePersonName').textContent = firstName;
            document.getElementById('inviteModal').classList.add('active');
            document.getElementById('inviteSuccess').style.display = 'none';
            document.getElementById('personalInviteLink').style.display = 'none';
        };

        window.closeInviteModal = () => {
            document.getElementById('inviteModal').classList.remove('active');
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteMessage').value = '';
        };

        window.sendPersonalInvite = async () => {
            const email = document.getElementById('inviteEmail').value;
            const message = document.getElementById('inviteMessage').value;

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            const { data, error } = await supabase.from('invitations').insert({
                sender_id: currentUser.id,
                recipient_email: email,
                family_member_id: currentInviteMemberId,
                message: message
            }).select().single();

            if (data) {
                const link = `${window.location.origin}/auth/signup.html?invite=${data.invite_code}`;
                document.getElementById('personalInviteLink').textContent = link;
                document.getElementById('personalInviteLink').style.display = 'block';
                document.getElementById('inviteSuccessMsg').textContent = 'Invitation created! Share this link:';
                document.getElementById('inviteSuccess').style.display = 'flex';

                await supabase.from('notifications').insert({
                    user_id: currentUser.id,
                    type: 'invitation_sent',
                    title: 'Invitation Sent',
                    message: `Invitation sent to ${email}`
                });
            }
        };

        window.openQuickAddModal = (memberId, personName) => {
            currentQuickAddMemberId = memberId;
            document.getElementById('relatedPersonName').textContent = personName;
            document.getElementById('quickAddModal').classList.add('active');
            document.getElementById('quickAddForm').style.display = 'none';
        };

        window.closeQuickAddModal = () => {
            document.getElementById('quickAddModal').classList.remove('active');
            document.getElementById('quickFirstName').value = '';
            document.getElementById('quickLastName').value = '';
            document.getElementById('quickGender').value = '';
        };

        window.quickAddRelation = (relation) => {
            currentQuickAddRelation = relation;
            document.getElementById('quickAddForm').style.display = 'block';
        };

        window.submitQuickAdd = async () => {
            const firstName = document.getElementById('quickFirstName').value;
            const lastName = document.getElementById('quickLastName').value;
            const gender = document.getElementById('quickGender').value;

            if (!firstName) {
                alert('Please enter a first name');
                return;
            }

            const { data: member, error } = await supabase.from('family_members').insert({
                first_name: firstName,
                last_name: lastName,
                gender: gender,
                created_by: currentUser.id
            }).select().single();

            if (member) {
                if (currentQuickAddRelation === 'parent') {
                    await supabase.from('relationships').insert({
                        parent_id: member.id,
                        child_id: currentQuickAddMemberId,
                        relationship_type: 'parent'
                    });
                } else if (currentQuickAddRelation === 'child') {
                    await supabase.from('relationships').insert({
                        parent_id: currentQuickAddMemberId,
                        child_id: member.id,
                        relationship_type: 'parent'
                    });
                } else if (currentQuickAddRelation === 'spouse' || currentQuickAddRelation === 'sibling') {
                    await supabase.from('relationships').insert([
                        { parent_id: member.id, child_id: currentQuickAddMemberId, relationship_type: currentQuickAddRelation },
                        { parent_id: currentQuickAddMemberId, child_id: member.id, relationship_type: currentQuickAddRelation }
                    ]);
                }

                await supabase.from('notifications').insert({
                    user_id: currentUser.id,
                    type: 'new_member',
                    title: 'New Family Member Added',
                    message: `${firstName} ${lastName} was added to the family tree`
                });

                closeQuickAddModal();
                loadMembers();
            }
        };

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = '../auth/login.html'; return; }
            currentUser = session.user;
            loadMembers();
        }
        init();
    </script>
</body>
</html>
